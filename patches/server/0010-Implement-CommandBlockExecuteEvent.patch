From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Indhi Rousseau <contact@thekinrar.fr>
Date: Tue, 3 Dec 2019 17:34:43 +0000
Subject: [PATCH] Implement CommandBlockExecuteEvent


diff --git a/src/main/java/net/minecraft/world/level/BaseCommandBlock.java b/src/main/java/net/minecraft/world/level/BaseCommandBlock.java
index c0dd148d08abf064b5f3c261046cf41d0d1bcf06..feebac0610c919baadbb8bc5c1d4c43c1ed62992 100644
--- a/src/main/java/net/minecraft/world/level/BaseCommandBlock.java
+++ b/src/main/java/net/minecraft/world/level/BaseCommandBlock.java
@@ -125,14 +125,28 @@ public abstract class BaseCommandBlock implements CommandSource {
                 if (minecraftserver.isCommandBlockEnabled() && !StringUtil.isNullOrEmpty(this.command)) {
                     try {
                         this.lastOutput = null;
-                        CommandSourceStack commandlistenerwrapper = this.createCommandSourceStack().withCallback((commandcontext, flag, i) -> {
-                            if (flag) {
-                                ++this.successCount;
-                            }
 
-                        });
+                        Entity entity = this.getWrapper().getEntity();
+
+                        CommandBlockExecuteEvent event = new CommandBlockExecuteEvent(
+                                this.getBukkitSender(this.getWrapper()),
+                                entity == null ? CraftBlock.at(this.getWrapper().getWorld(), new BlockPosition(this.getWrapper().getPosition())) : null,
+                                entity == null ? null : CraftEntity.getEntity(minecraftserver.server, entity),
+                                this.command);
+
+                        Bukkit.getServer().getPluginManager().callEvent(event);
+
+                        if(!event.isCancelled()) {
+                            this.lastOutput = null;
+                            CommandSourceStack commandlistenerwrapper = this.createCommandSourceStack().withCallback((commandcontext, flag, i) -> {
+                                if (flag) {
+                                    ++this.successCount;
+                                }
+
+                            });
 
-                        minecraftserver.getCommands().dispatchServerCommand(commandlistenerwrapper, this.command); // CraftBukkit
+                            minecraftserver.getCommands().dispatchServerCommand(commandlistenerwrapper, event.getCommand()); // CraftBukkit // Papyrus - use command from event
+                        }
                     } catch (Throwable throwable) {
                         CrashReport crashreport = CrashReport.forThrowable(throwable, "Executing command block");
                         CrashReportCategory crashreportsystemdetails = crashreport.addCategory("Command to be executed");
