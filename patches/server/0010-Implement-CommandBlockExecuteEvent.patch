From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Indhi Rousseau <contact@thekinrar.fr>
Date: Tue, 3 Dec 2019 17:34:43 +0000
Subject: [PATCH] Implement CommandBlockExecuteEvent


diff --git a/src/main/java/net/minecraft/world/level/BaseCommandBlock.java b/src/main/java/net/minecraft/world/level/BaseCommandBlock.java
index c0dd148d08abf064b5f3c261046cf41d0d1bcf06..6359ea8c2bce34510ad8622756a0f66f352eff0c 100644
--- a/src/main/java/net/minecraft/world/level/BaseCommandBlock.java
+++ b/src/main/java/net/minecraft/world/level/BaseCommandBlock.java
@@ -125,14 +125,29 @@ public abstract class BaseCommandBlock implements CommandSource {
                 if (minecraftserver.isCommandBlockEnabled() && !StringUtil.isNullOrEmpty(this.command)) {
                     try {
                         this.lastOutput = null;
-                        CommandSourceStack commandlistenerwrapper = this.createCommandSourceStack().withCallback((commandcontext, flag, i) -> {
-                            if (flag) {
-                                ++this.successCount;
-                            }
 
-                        });
+                        var source = this.createCommandSourceStack();
+                        var entity = source.getEntity();
+
+                        var event = new org.bukkit.event.block.CommandBlockExecuteEvent(
+                                this.getBukkitSender(source),
+                                entity == null ? org.bukkit.craftbukkit.block.CraftBlock.at(source.getLevel(), new net.minecraft.core.BlockPos(source.getPosition())) : null,
+                                entity == null ? null : org.bukkit.craftbukkit.entity.CraftEntity.getEntity(minecraftserver.server, entity),
+                                this.command);
+
+                        org.bukkit.Bukkit.getServer().getPluginManager().callEvent(event);
+
+                        if(!event.isCancelled()) {
+                            this.lastOutput = null;
+                            CommandSourceStack commandlistenerwrapper = source.withCallback((commandcontext, flag, i) -> {
+                                if (flag) {
+                                    ++this.successCount;
+                                }
+
+                            });
 
-                        minecraftserver.getCommands().dispatchServerCommand(commandlistenerwrapper, this.command); // CraftBukkit
+                            minecraftserver.getCommands().dispatchServerCommand(commandlistenerwrapper, event.getCommand()); // CraftBukkit // Papyrus - use command from event
+                        }
                     } catch (Throwable throwable) {
                         CrashReport crashreport = CrashReport.forThrowable(throwable, "Executing command block");
                         CrashReportCategory crashreportsystemdetails = crashreport.addCategory("Command to be executed");
