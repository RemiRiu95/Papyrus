From 560d428e879acd92e498ec58b4e2bbaeaecb4ed9 Mon Sep 17 00:00:00 2001
From: Indhi Rousseau <contact@thekinrar.fr>
Date: Wed, 30 Oct 2019 01:32:35 +0000
Subject: [PATCH] Implement fake OP permission level


diff --git a/src/main/java/net/minecraft/server/PlayerList.java b/src/main/java/net/minecraft/server/PlayerList.java
index 3cb443c4f..d224349f7 100644
--- a/src/main/java/net/minecraft/server/PlayerList.java
+++ b/src/main/java/net/minecraft/server/PlayerList.java
@@ -756,7 +756,9 @@ public abstract class PlayerList {
         GameProfile gameprofile = entityplayer.getProfile();
         int i = this.server.a(gameprofile);
 
-        this.a(entityplayer, i);
+        int fake = entityplayer.getBukkitEntity().getFakeOpPermissionLevel();
+
+        this.a(entityplayer, fake != -1 ? fake : i);
     }
 
     public void tick() {
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index e920545df..681011aaa 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -44,6 +44,7 @@ import net.minecraft.server.EnumGamemode;
 import net.minecraft.server.IChatBaseComponent;
 import net.minecraft.server.MapIcon;
 import net.minecraft.server.MinecraftKey;
+import net.minecraft.server.MinecraftServer;
 import net.minecraft.server.NBTTagCompound;
 import net.minecraft.server.PacketDataSerializer;
 import net.minecraft.server.PacketPlayOutBlockChange;
@@ -63,6 +64,7 @@ import net.minecraft.server.PacketPlayOutWorldEvent;
 import net.minecraft.server.PacketPlayOutWorldParticles;
 import net.minecraft.server.PlayerChunkMap;
 import net.minecraft.server.PlayerConnection;
+import net.minecraft.server.PlayerList;
 import net.minecraft.server.TileEntitySign;
 import net.minecraft.server.Vec3D;
 import net.minecraft.server.WhiteListEntry;
@@ -142,6 +144,7 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
     private static final boolean DISABLE_CHANNEL_LIMIT = System.getProperty("paper.disableChannelLimit") != null; // Paper - add a flag to disable the channel limit
     private long lastSaveTime;
     // Paper end
+    private int fakeOpPermissionLevel = -1; // Papyrus
 
     public CraftPlayer(CraftServer server, EntityPlayer entity) {
         super(server, entity);
@@ -1995,6 +1998,24 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
     }
     //Paper end
 
+    // Papyrus start
+    @Override
+    public int getFakeOpPermissionLevel() {
+        return fakeOpPermissionLevel;
+    }
+
+    @Override
+    public void setFakeOpPermissionLevel(int level) {
+        if(level == -1 || (level >= 0 && level <= 4)) {
+            fakeOpPermissionLevel = level;
+
+            MinecraftServer.getServer().getPlayerList().d(getHandle());
+        } else {
+            throw new IllegalArgumentException("fake op permission level must be in range 1-4 or equal -1");
+        }
+    }
+    // Papyrus end
+
     // Spigot start
     private final Player.Spigot spigot = new Player.Spigot()
     {
-- 
2.23.0

