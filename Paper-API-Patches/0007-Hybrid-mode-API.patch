From d6a52bd591b91d5ee39cc7b10bf8ebdbefbf152c Mon Sep 17 00:00:00 2001
From: Indhi Rousseau <contact@thekinrar.fr>
Date: Mon, 4 Nov 2019 19:42:56 +0000
Subject: [PATCH] Hybrid mode API


diff --git a/src/main/java/fr/thekinrar/papyrus/hybrid/HybridEngine.java b/src/main/java/fr/thekinrar/papyrus/hybrid/HybridEngine.java
new file mode 100644
index 000000000..3d0495812
--- /dev/null
+++ b/src/main/java/fr/thekinrar/papyrus/hybrid/HybridEngine.java
@@ -0,0 +1,36 @@
+package fr.thekinrar.papyrus.hybrid;
+
+import org.jetbrains.annotations.NotNull;
+import org.jetbrains.annotations.Nullable;
+
+import java.util.Map;
+import java.util.UUID;
+
+public interface HybridEngine {
+
+    @NotNull
+    UUID getIdForOfflinePlayer(@NotNull String name);
+
+    @NotNull
+    UUID getIdForOnlinePlayer(@NotNull String name, @NotNull UUID id);
+
+    /**
+     * Gets the forced offline mapping for the specified username, if any.
+     * @param name Offline username to get the mapping for
+     * @return The forced UUID or null if none has been set
+     */
+    @Nullable
+    UUID getOfflineMapping(@NotNull String name);
+
+    /**
+     * Sets the forced offline mapping for the specified username.
+     * @param name Offline username to set the mapping for
+     * @param id The forced UUID to set or null to remove forced mapping
+     */
+    void setOfflineMapping(@NotNull String name, @Nullable UUID id);
+
+    void registerPasswordProvider(@NotNull HybridPasswordProvider provider);
+
+    void importKnownNames(@NotNull Map<String, String> knownNames);
+
+}
diff --git a/src/main/java/fr/thekinrar/papyrus/hybrid/HybridPasswordProvider.java b/src/main/java/fr/thekinrar/papyrus/hybrid/HybridPasswordProvider.java
new file mode 100644
index 000000000..c23af6b53
--- /dev/null
+++ b/src/main/java/fr/thekinrar/papyrus/hybrid/HybridPasswordProvider.java
@@ -0,0 +1,10 @@
+package fr.thekinrar.papyrus.hybrid;
+
+import org.jetbrains.annotations.NotNull;
+
+public interface HybridPasswordProvider {
+
+    boolean hasPassword(@NotNull String username);
+
+    boolean verifyPassword(@NotNull String username, @NotNull String password);
+}
diff --git a/src/main/java/fr/thekinrar/papyrus/hybrid/HybridProfile.java b/src/main/java/fr/thekinrar/papyrus/hybrid/HybridProfile.java
new file mode 100644
index 000000000..68a938843
--- /dev/null
+++ b/src/main/java/fr/thekinrar/papyrus/hybrid/HybridProfile.java
@@ -0,0 +1,16 @@
+package fr.thekinrar.papyrus.hybrid;
+
+import org.jetbrains.annotations.NotNull;
+
+public interface HybridProfile {
+
+    boolean isRegistered();
+
+    boolean isLoggedIn();
+
+    void setLoggedIn(boolean loggedIn);
+
+    void setPassword(@NotNull String password);
+
+    void stayLoggedIn(long millis);
+}
diff --git a/src/main/java/org/bukkit/Bukkit.java b/src/main/java/org/bukkit/Bukkit.java
index a97dab131..3c2b47446 100644
--- a/src/main/java/org/bukkit/Bukkit.java
+++ b/src/main/java/org/bukkit/Bukkit.java
@@ -14,6 +14,7 @@ import java.util.UUID;
 import java.util.function.Consumer;
 import java.util.logging.Logger;
 
+import fr.thekinrar.papyrus.hybrid.HybridEngine;
 import org.bukkit.Warning.WarningState;
 import org.bukkit.advancement.Advancement;
 import org.bukkit.block.data.BlockData;
@@ -1606,6 +1607,22 @@ public final class Bukkit {
     }
     // Paper end
 
+    // Papyrus start
+    @NotNull
+    public static HybridEngine getHybridEngine() {
+        return server.getHybridEngine();
+    }
+
+    /**
+     * Gets whether the Server is in hybrid mode or not.
+     *
+     * @return true if the server is in hybrid mode, false otherwise
+     */
+    public static boolean getHybridMode() {
+        return server.getHybridMode();
+    }
+    // Papyrus end
+
     @NotNull
     public static Server.Spigot spigot()
     {
diff --git a/src/main/java/org/bukkit/Server.java b/src/main/java/org/bukkit/Server.java
index 91c284314..25b76a96a 100644
--- a/src/main/java/org/bukkit/Server.java
+++ b/src/main/java/org/bukkit/Server.java
@@ -14,6 +14,7 @@ import java.util.UUID;
 import java.util.function.Consumer;
 import java.util.logging.Logger;
 
+import fr.thekinrar.papyrus.hybrid.HybridEngine;
 import org.bukkit.Warning.WarningState;
 import org.bukkit.advancement.Advancement;
 import org.bukkit.block.data.BlockData;
@@ -1407,4 +1408,16 @@ public interface Server extends PluginMessageRecipient {
      */
     int getCurrentTick();
     // Paper end
+
+    // Papyrus start
+    @NotNull
+    HybridEngine getHybridEngine();
+
+    /**
+     * Gets whether the Server is in hybrid mode or not.
+     *
+     * @return true if the server is in hybrid mode, false otherwise
+     */
+    boolean getHybridMode();
+    // Papyrus end
 }
diff --git a/src/main/java/org/bukkit/command/Command.java b/src/main/java/org/bukkit/command/Command.java
index 0b0d1bd7c..cd2711185 100644
--- a/src/main/java/org/bukkit/command/Command.java
+++ b/src/main/java/org/bukkit/command/Command.java
@@ -35,6 +35,7 @@ public abstract class Command {
     private String permissionMessage;
     public co.aikar.timings.Timing timings; // Paper
     @NotNull public String getTimingName() {return getName();} // Paper
+    private boolean unauthenticated; // Papyrus
 
     protected Command(@NotNull String name) {
         this(name, "", "/" + name, new ArrayList<String>());
@@ -442,6 +443,14 @@ public abstract class Command {
         }
     }
 
+    public boolean isUnauthenticated() {
+        return unauthenticated;
+    }
+
+    public void setUnauthenticated(boolean unauthenticated) {
+        this.unauthenticated = unauthenticated;
+    }
+
     @Override
     public String toString() {
         return getClass().getName() + '(' + name + ')';
diff --git a/src/main/java/org/bukkit/command/SimpleCommandMap.java b/src/main/java/org/bukkit/command/SimpleCommandMap.java
index 460fda05a..54d3b25df 100644
--- a/src/main/java/org/bukkit/command/SimpleCommandMap.java
+++ b/src/main/java/org/bukkit/command/SimpleCommandMap.java
@@ -156,7 +156,7 @@ public class SimpleCommandMap implements CommandMap {
         try {
             try (co.aikar.timings.Timing ignored = target.timings.startTiming()) { // Paper - use try with resources
             // Note: we don't return the result of target.execute as thats success / failure, we return handled (true) or not handled (false)
-            target.execute(sender, sentCommandLabel, Arrays.copyOfRange(args, 1, args.length));
+            hybridExecute(target, sender, sentCommandLabel, Arrays.copyOfRange(args, 1, args.length));
             } // target.timings.stopTiming(); // Spigot // Paper
         } catch (CommandException ex) {
             server.getPluginManager().callEvent(new ServerExceptionEvent(new ServerCommandException(ex, target, sender, args))); // Paper
@@ -173,6 +173,10 @@ public class SimpleCommandMap implements CommandMap {
         return true;
     }
 
+    protected boolean hybridExecute(@NotNull Command command, @NotNull CommandSender sender, @NotNull String commandLabel, @NotNull String[] args) {
+        return command.execute(sender, commandLabel, args);
+    }
+
     @Override
     public synchronized void clearCommands() {
         for (Map.Entry<String, Command> entry : knownCommands.entrySet()) {
diff --git a/src/main/java/org/bukkit/entity/Player.java b/src/main/java/org/bukkit/entity/Player.java
index 2209c5807..0506ef677 100644
--- a/src/main/java/org/bukkit/entity/Player.java
+++ b/src/main/java/org/bukkit/entity/Player.java
@@ -4,6 +4,7 @@ import java.net.InetSocketAddress;
 import com.destroystokyo.paper.Title; // Paper
 import com.destroystokyo.paper.profile.PlayerProfile; // Paper
 import java.util.Date; // Paper
+import fr.thekinrar.papyrus.hybrid.HybridProfile;
 import org.bukkit.BanEntry; // Paper
 import org.bukkit.BanList; // Paper
 import org.bukkit.Bukkit; // Paper
@@ -1959,6 +1960,9 @@ public interface Player extends HumanEntity, Conversable, OfflinePlayer, PluginM
      * @param canAlwaysOpenCommandBlocks whether this player can always open command blocks
      */
     void setCanAlwaysOpenCommandBlocks(boolean canAlwaysOpenCommandBlocks);
+
+    @NotNull
+    HybridProfile getHybridProfile();
     // Papyrus end
 
     // Spigot start
diff --git a/src/main/java/org/bukkit/event/entity/EntityPotionEffectEvent.java b/src/main/java/org/bukkit/event/entity/EntityPotionEffectEvent.java
index d5f8bde3b..e4d7b9379 100644
--- a/src/main/java/org/bukkit/event/entity/EntityPotionEffectEvent.java
+++ b/src/main/java/org/bukkit/event/entity/EntityPotionEffectEvent.java
@@ -209,6 +209,10 @@ public class EntityPotionEffectEvent extends EntityEvent implements Cancellable
          * When an illusion illager makes himself disappear.
          */
         ILLUSION,
+        /**
+         * When a user is requested to login or register. No event will be triggered for this cause.
+         */
+        HYBRID_AUTH,
         /**
          * When all effects are removed due to a bucket of milk.
          */
-- 
2.23.0

